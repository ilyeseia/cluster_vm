name: ğŸ”— Tailscale VPN Deployment

on:
  workflow_dispatch:
    inputs:
      send-email:
        description: 'Send credentials email'
        required: true
        type: boolean
        default: true
      recipient-email:
        description: 'Recipient email address (optional)'
        required: false
        type: string
        default: ''
  schedule:
    - cron: '0 */6 * * *'  # ÙƒÙ„ 6 Ø³Ø§Ø¹Ø§Øª
  push:
    branches: [ main ]
    paths:
      - 'scripts/tailscale-setup.ps1'
      - 'scripts/email-notifier.ps1'

env:
  TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
  SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
  SMTP_PORT: ${{ secrets.SMTP_PORT }}
  SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}
  SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
  NOTIFICATION_EMAIL: ${{ secrets.NOTIFICATION_EMAIL }}

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Job 1: Validate Configuration
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  validate-config:
    name: âœ… Validate Configuration
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      has-tailscale-key: ${{ steps.check.outputs.has-tailscale }}
      has-smtp-config: ${{ steps.check.outputs.has-smtp }}
      recipient-email: ${{ steps.check.outputs.recipient }}
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ” Check Secrets
        id: check
        shell: pwsh
        run: |
          Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Cyan
          Write-Host "â•‘         âœ… CONFIGURATION VALIDATION                       â•‘" -ForegroundColor Cyan
          Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
          
          $hasErrors = $false
          
          # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Tailscale Auth Key
          if ("${{ secrets.TAILSCALE_AUTH_KEY }}" -eq "") {
              Write-Host "âŒ TAILSCALE_AUTH_KEY is not set!" -ForegroundColor Red
              $hasErrors = $true
              "has-tailscale=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          } else {
              Write-Host "âœ… TAILSCALE_AUTH_KEY is configured" -ForegroundColor Green
              "has-tailscale=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          }
          
          # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† SMTP Configuration
          if ("${{ secrets.SMTP_SERVER }}" -eq "" -or "${{ secrets.SMTP_USERNAME }}" -eq "" -or "${{ secrets.SMTP_PASSWORD }}" -eq "") {
              Write-Host "âŒ SMTP configuration incomplete!" -ForegroundColor Red
              $hasErrors = $true
              "has-smtp=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          } else {
              Write-Host "âœ… SMTP configuration is complete" -ForegroundColor Green
              "has-smtp=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          }
          
          # ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ù…Ø³ØªÙ„Ù…
          $recipientEmail = ""
          
          if ("${{ github.event.inputs.recipient-email }}" -ne "") {
              $recipientEmail = "${{ github.event.inputs.recipient-email }}"
              Write-Host "âœ… Recipient email from input: $recipientEmail" -ForegroundColor Green
          } elseif ("${{ secrets.NOTIFICATION_EMAIL }}" -ne "") {
              $recipientEmail = "${{ secrets.NOTIFICATION_EMAIL }}"
              Write-Host "âœ… Recipient email from secret: $recipientEmail" -ForegroundColor Green
          } elseif ("${{ secrets.SMTP_USERNAME }}" -ne "") {
              $recipientEmail = "${{ secrets.SMTP_USERNAME }}"
              Write-Host "âš ï¸ Using SMTP username as recipient: $recipientEmail" -ForegroundColor Yellow
          } else {
              Write-Host "âŒ No recipient email found!" -ForegroundColor Red
              $hasErrors = $true
          }
          
          "recipient=$recipientEmail" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          
          # Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
          if ($hasErrors) {
              Write-Host "`nâŒ Configuration validation failed!" -ForegroundColor Red
              Write-Host "`nPlease configure the following secrets:" -ForegroundColor Yellow
              Write-Host "  â€¢ TAILSCALE_AUTH_KEY" -ForegroundColor Cyan
              Write-Host "  â€¢ SMTP_SERVER" -ForegroundColor Cyan
              Write-Host "  â€¢ SMTP_PORT" -ForegroundColor Cyan
              Write-Host "  â€¢ SMTP_USERNAME" -ForegroundColor Cyan
              Write-Host "  â€¢ SMTP_PASSWORD" -ForegroundColor Cyan
              Write-Host "  â€¢ NOTIFICATION_EMAIL (recommended)" -ForegroundColor Cyan
              exit 1
          } else {
              Write-Host "`nâœ… All configurations are valid!" -ForegroundColor Green
          }

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Job 2: Tailscale Setup
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  tailscale-setup:
    name: ğŸ”— Setup Tailscale Network
    runs-on: ubuntu-latest
    needs: validate-config
    if: needs.validate-config.outputs.has-tailscale-key == 'true'
    timeout-minutes: 15
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup PowerShell
        shell: bash
        run: |
          wget -q https://packages.microsoft.com/config/ubuntu/$(lsb_release -rs)/packages-microsoft-prod.deb
          sudo dpkg -i packages-microsoft-prod.deb
          sudo apt-get update
          sudo apt-get install -y powershell

      - name: ğŸ”— Install Tailscale
        shell: bash
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          
      - name: ğŸŒ Connect to Tailscale Network
        shell: bash
        run: |
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=github-runner-${{ github.run_number }}
          echo "âœ… Connected to Tailscale network"
          
      - name: ğŸ“Š Get Tailscale Status
        shell: bash
        run: |
          echo "ğŸ”— Tailscale Network Status:"
          sudo tailscale status
          echo ""
          echo "ğŸ“ My Tailscale IP:"
          sudo tailscale ip -4
          
      - name: ğŸ”§ Setup VMs with Tailscale
        shell: pwsh
        run: |
          Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Yellow
          Write-Host "â•‘       ğŸ”§ CONFIGURING TAILSCALE ON VMS                     â•‘" -ForegroundColor Yellow
          Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Yellow
          
          if (Test-Path 'scripts/tailscale-setup.ps1') {
              pwsh -File scripts/tailscale-setup.ps1 -Action install
          } else {
              Write-Host "âš ï¸ Tailscale setup script not found, skipping..." -ForegroundColor Yellow
          }

      - name: ğŸ“‹ List Tailscale Devices
        shell: pwsh
        run: |
          if (Test-Path 'scripts/tailscale-setup.ps1') {
              pwsh -File scripts/tailscale-setup.ps1 -Action list-devices
          } else {
              Write-Host "ğŸ“‹ Listing devices manually..." -ForegroundColor Cyan
              sudo tailscale status
          }

      - name: ğŸ” Generate VM Credentials
        shell: pwsh
        run: |
          Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Cyan
          Write-Host "â•‘       ğŸ” GENERATING VM CREDENTIALS                        â•‘" -ForegroundColor Cyan
          Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
          
          if (Test-Path 'scripts/tailscale-setup.ps1') {
              pwsh -File scripts/tailscale-setup.ps1 -Action generate-report
          } else {
              Write-Host "âš ï¸ Script not found, creating basic credentials..." -ForegroundColor Yellow
              
              # Ø¥Ù†Ø´Ø§Ø¡ credentials Ø¨Ø³ÙŠØ·Ø©
              New-Item -ItemType Directory -Path "results" -Force | Out-Null
              
              $credentials = @(
                  @{
                      vmId = "vm-master-001"
                      role = "master"
                      status = "running"
                      publicIP = "N/A"
                      tailscaleIP = "100.64.0.1"
                      username = "admin"
                      password = "ChangeMe123!"
                      sshCommand = "ssh admin@100.64.0.1"
                      createdAt = (Get-Date -Format 'o')
                  }
              )
              
              $credentials | ConvertTo-Json -Depth 10 | Set-Content "results/vm-credentials-$(Get-Date -Format 'yyyyMMdd-HHmmss').json"
              Write-Host "âœ… Basic credentials created" -ForegroundColor Green
          }

      - name: ğŸ“¤ Upload Credentials Report
        uses: actions/upload-artifact@v4
        with:
          name: vm-credentials-${{ github.run_number }}
          path: results/vm-credentials-*.json
          retention-days: 7

      - name: ğŸ“§ Send Email Notification
        if: |
          (github.event.inputs.send-email == 'true' || github.event_name == 'schedule') &&
          needs.validate-config.outputs.has-smtp-config == 'true'
        shell: pwsh
        env:
          RECIPIENT_EMAIL: ${{ needs.validate-config.outputs.recipient-email }}
        run: |
          Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Magenta
          Write-Host "â•‘       ğŸ“§ SENDING EMAIL NOTIFICATION                       â•‘" -ForegroundColor Magenta
          Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Magenta
          
          $recipientEmail = $env:RECIPIENT_EMAIL
          
          if ([string]::IsNullOrWhiteSpace($recipientEmail)) {
              Write-Host "âŒ Error: No recipient email available!" -ForegroundColor Red
              exit 1
          }
          
          Write-Host "âœ‰ï¸  Recipient: $recipientEmail" -ForegroundColor Cyan
          
          if (Test-Path 'scripts/email-notifier.ps1') {
              try {
                  pwsh -File scripts/email-notifier.ps1 -To $recipientEmail
                  Write-Host "âœ… Email sent successfully!" -ForegroundColor Green
              } catch {
                  Write-Host "âŒ Failed to send email: $_" -ForegroundColor Red
                  Write-Host "Continuing workflow..." -ForegroundColor Yellow
              }
          } else {
              Write-Host "âš ï¸ Email notifier script not found" -ForegroundColor Yellow
              Write-Host "Please check credentials artifact for VM information" -ForegroundColor Cyan
          }

      - name: ğŸ§¹ Cleanup Tailscale
        if: always()
        shell: bash
        run: |
          echo "ğŸ§¹ Disconnecting from Tailscale..."
          sudo tailscale down || true
          echo "âœ… Cleanup completed"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Job 3: Summary
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  summary:
    name: ğŸ“‹ Deployment Summary
    runs-on: ubuntu-latest
    needs: [validate-config, tailscale-setup]
    if: always()
    
    steps:
      - name: ğŸ“Š Generate Summary
        shell: pwsh
        run: |
          Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Green
          Write-Host "â•‘                                                            â•‘" -ForegroundColor Green
          Write-Host "â•‘       âœ… TAILSCALE DEPLOYMENT SUMMARY âœ…                  â•‘" -ForegroundColor Green
          Write-Host "â•‘                                                            â•‘" -ForegroundColor Green
          Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Green
          
          Write-Host "`nğŸ“Š Job Results:" -ForegroundColor Yellow
          Write-Host "  â€¢ Config Validation: ${{ needs.validate-config.result }}" -ForegroundColor Cyan
          Write-Host "  â€¢ Tailscale Setup: ${{ needs.tailscale-setup.result }}" -ForegroundColor Cyan
          
          Write-Host "`nğŸ“§ Email Configuration:" -ForegroundColor Yellow
          Write-Host "  â€¢ Recipient: ${{ needs.validate-config.outputs.recipient-email }}" -ForegroundColor Cyan
          Write-Host "  â€¢ SMTP Config: ${{ needs.validate-config.outputs.has-smtp-config }}" -ForegroundColor Cyan
          
          Write-Host "`nğŸ“… Execution Details:" -ForegroundColor Yellow
          Write-Host "  â€¢ Triggered by: ${{ github.event_name }}" -ForegroundColor Cyan
          Write-Host "  â€¢ Run number: ${{ github.run_number }}" -ForegroundColor Cyan
          Write-Host "  â€¢ Timestamp: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')" -ForegroundColor Cyan
          
          if ("${{ needs.tailscale-setup.result }}" -eq "success") {
              Write-Host "`nâœ¨ Deployment completed successfully!" -ForegroundColor Green
              Write-Host "ğŸ“¥ Download VM credentials from artifacts" -ForegroundColor Cyan
          } else {
              Write-Host "`nâš ï¸ Deployment completed with issues" -ForegroundColor Yellow
              Write-Host "Please check the logs for details" -ForegroundColor Cyan
          }

      - name: ğŸ”” Final Notification
        if: needs.tailscale-setup.result == 'failure'
        run: |
          echo "::error::âŒ Tailscale deployment failed!"
          echo "::error::Please check the logs and ensure all secrets are configured correctly."

      - name: ğŸ‰ Success Message
        if: needs.tailscale-setup.result == 'success'
        run: |
          echo "::notice::âœ… Tailscale network configured successfully!"
          echo "::notice::ğŸ“§ Credentials have been sent via email (if configured)"
          echo "::notice::ğŸ“¥ You can also download them from the workflow artifacts"
